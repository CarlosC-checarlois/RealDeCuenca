{% extends 'cabezal.html' %}
{% load static %}

{% block titulo_pagina %}
{% endblock %}
{% block css_archivos %}
{% endblock %}
{% block jvscript_archivos %}

{% endblock %}
{% block contenido_pagina %}
    <!-- CONTEXTO RAPIDO -->
    <!-- CONTEXTO RAPIDO -->
    <!-- CONTEXTO RAPIDO -->
    <section
            class="contexto-rapido_contenido_rapido_generales d-flex align-items-center justify-content-center text-center text-white">
        <!-- Imagen de fondo directa -->
        <img src="{% static 'webapp/imagenes/inicio_sesion/foto_inicio_sesion_5.png' %}"  alt="Banner Servicios"
             class="imagen_contenido_rapido_generales">

        <!-- Capa oscura superpuesta -->
        <div class="overlay_contenido_rapido_generales"></div>

        <!-- Contenido central -->
        <div class="contenido_contenido_rapido_generales">
            <h1 class="titulo_contenido_rapido_generales">Inicio Sesion</h1>
            <p class="breadcrumb_contenido_rapido_generales">
                <a href="#" class="link-breadcrumb_contenido_rapido_generales">Inicio</a> ‚Ä∫ Inicio Sesion
            </p>
        </div>
    </section>

    <!-- CONTEXTO RAPIDO -->
    <!-- CONTEXTO RAPIDO -->
    <!-- CONTEXTO RAPIDO -->


    <!-- CONTENIDO -->
    <!-- CONTENIDO -->
    <!-- CONTENIDO -->

    <section class="login_index_inicio py-5">
        <div class="container">
            <div class="row justify-content-center align-items-center">

                <!-- Columna de imagen o ilustraci√≥n -->
                <div class="col-md-6 d-none d-md-block text-center">
                    <img src="{% static 'webapp/imagenes/inicio_sesion/foto_inicio_sesion_6.png' %}" alt="Arte e inspiraci√≥n"
                         class="img-fluid login-img_index_inicio">
                </div>

                <!-- Columna de formulario -->
                <div class="col-md-6 col-lg-5">
                    <div class="login-card_index_inicio p-4 p-md-5 shadow-sm">
                        <h2 class="titulo_index_inicio text-center mb-4">Iniciar Sesi√≥n</h2>
                        <p class="texto-auxiliar_index_inicio text-center mb-4">
                            Accede a tu cuenta para gestionar tus reservas y espacios culturales.
                        </p>

                        <form class="formulario_index_inicio" method="POST" action="{% url 'login' %}">
                            {% csrf_token %}

                            <!-- Correo -->
                            <div class="mb-3">
                                <label for="correo_login" class="form-label subtitulo_index_inicio">Correo
                                    electr√≥nico</label>
                                <input type="email" name="correo_login" class="form-control input_index_inicio"
                                       id="correo_login" placeholder="ejemplo@correo.com" required>
                            </div>

                            <!-- Contrase√±a -->
                            <div class="mb-3">
                                <label for="contrasena_login"
                                       class="form-label subtitulo_index_inicio">Contrase√±a</label>
                                <input type="password" name="contrasena_login" class="form-control input_index_inicio"
                                       id="contrasena_login" placeholder="********" required>
                            </div>

                            <!-- Recordar -->
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="recordar_login">
                                    <label class="form-check-label texto-base_index_inicio" for="recordar_login">
                                        Recordarme
                                    </label>
                                </div>
                            </div>

                            <!-- Bot√≥n -->
                            <div class="d-grid">
                                <button type="submit" class="btn btn-iniciar_index_inicio">
                                    <i class="fa-solid fa-right-to-bracket me-2"></i> Iniciar Sesi√≥n
                                </button>
                            </div>
                        </form>

                        <!-- Registro -->
                        <div class="text-center mt-4">
                            <p class="texto-base_index_inicio mb-0">
                                ¬øNo tienes cuenta?
              <a href="{% url 'register' %}" class="text-warning text-decoration-none">
                Reg√≠strate aqu√≠
              </a>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- CONTENIDO -->
    <!-- CONTENIDO -->
    <!-- CONTENIDO -->

{% endblock %}


{% block jvscript_archivos_defer %}
    <!-- ‚úÖ SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Tu script de login (fetch...) -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const form = document.querySelector(".formulario_index_inicio");
            const inputCorreo = document.getElementById("correo_login");
            const inputContrasena = document.getElementById("contrasena_login");

            form.addEventListener("submit", async (e) => {
                e.preventDefault();

                const data = new FormData();
                data.append("correo", inputCorreo.value);
                data.append("contrasena", inputContrasena.value);

                try {
                    const response = await fetch("{% url 'api_login' %}", {
                        method: "POST",
                        headers: {
                            "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
                        },
                        body: data
                    });

                    const result = await response.json();

                    if (!result.success) {
                        Swal.fire({
                            title: "Error",
                            text: result.error || "Credenciales inv√°lidas.",
                            icon: "error",
                            confirmButtonColor: "#FFD700"
                        });
                        return;
                    }

                    // ‚úÖ Guardar sesi√≥n
// üßπ Limpiar sesi√≥n previa antes de guardar la nueva
localStorage.removeItem("usuarioSesion");
localStorage.removeItem("carritoReservas");

// ‚úÖ Guardar nueva sesi√≥n
const usuario = result.usuario;
const sesion = {
    isLoggedIn: true,
    Id: usuario.Id,
    Nombre: usuario.Nombre,
    Email: usuario.Email,
    Rol: usuario.Rol,
    TokenSesion: window.CarritoManager?.tokenSesion || null,
    FechaInicio: new Date().toISOString()
};
localStorage.setItem("usuarioSesion", JSON.stringify(sesion));


                    Swal.fire({
                        title: "‚úÖ Inicio de sesi√≥n exitoso",
                        html: `<p>Bienvenido, <strong>${usuario.Nombre}</strong></p>`,
                        icon: "success",
                        confirmButtonColor: "#FFD700",
                        confirmButtonText: "Continuar"
                    }).then(() => {
                        window.location.href = "/";
                    });

                } catch (error) {
                    console.error(error);
                    Swal.fire("Error", "No se pudo conectar con el servidor.", "error");
                }
            });
        });
    </script>
{% endblock %}
